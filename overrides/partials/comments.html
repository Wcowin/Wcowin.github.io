<!-- overrides/partials/comments.html -->

{% block extrahead %}
<!-- 首先加载即时导航处理工具 -->
<script src="{{ 'javascripts/unified-instant-handler.js' | url }}"></script>
{% endblock %}

{% if not page.meta.hide_comment %}
<br />
<div id="twikoo-comments"></div>
{% endif %}

{% block scripts %}
<script>
function loadTwikooComments() {
    const el = document.getElementById('twikoo-comments');
    if (!el) return;
    
    const script = document.createElement('script');
    script.src = 'https://registry.npmmirror.com/twikoo/1.6.44/files/dist/twikoo.min.js';
    script.onload = () => {
        twikoo.init({
            envId: 'https://superb-salamander-e730b6.netlify.app/.netlify/functions/twikoo',
            el: '#twikoo-comments',
            path: location.pathname,
            lang: 'zh-CN'
        });
    };
    document.body.appendChild(script);
}

// 使用统一的即时导航处理
if (window.InstantNav) {
    window.InstantNav.register(loadTwikooComments);
} else {
    // 回退方案
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadTwikooComments);
    } else {
        loadTwikooComments();
    }
}
</script>
{% endblock %}