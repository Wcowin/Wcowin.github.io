name: Deploy MkDocs
on:
  push:
    branches:
      - master 
      - main
  pull_request:
    types: [closed]
    branches: [main, master]
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€åˆ†æ”¯åªè¿è¡Œæœ€æ–°çš„å·¥ä½œæµ
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          sparse-checkout: |
            docs
            includes
            .ai_cache

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x
          cache: 'pip'

      - name: Set cache ID
        run: echo "cache_id=$(date --utc '+%V')" >> $GITHUB_ENV 

      - name: Cache MkDocs
        uses: actions/cache@v3
        with:
          key: mkdocs-material-${{ github.run_number }}
          path: .cache
          restore-keys: |
            mkdocs-material-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Deploy with AI Summary
        env:
          AI_SUMMARY_CI_ENABLED: 'true'
          AI_SUMMARY_CI_ONLY_CACHE: 'false'
          AI_SUMMARY_CI_FALLBACK: 'true'
          AI_SUMMARY_CACHE_ENABLED: 'true'
          AI_SUMMARY_CACHE_EXPIRE_DAYS: '3000'
          AI_SUMMARY_CACHE_AUTO_CLEAN: 'true'
          GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: mkdocs gh-deploy --force
      
      - name: Auto-commit AI cache
        run: |
          if [ -d ".ai_cache" ] && [ "$(ls -A .ai_cache 2>/dev/null)" ]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add .ai_cache/
            if ! git diff --cached --quiet; then
              git commit -m "ğŸ¤– Auto-update AI summary cache [skip ci]"
              git push
              echo "âœ… è‡ªåŠ¨æäº¤äº†æ–°çš„ AI ç¼“å­˜æ–‡ä»¶"
            else
              echo "â„¹ï¸ æ²¡æœ‰æ–°çš„ç¼“å­˜æ–‡ä»¶éœ€è¦æäº¤"
            fi
          else
            echo "â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°ç¼“å­˜ç›®å½•æˆ–ç¼“å­˜ä¸ºç©º"
          fi
