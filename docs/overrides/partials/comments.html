{# 
  Twikoo è¯„è®ºç³»ç»Ÿé…ç½®
  
  ä½¿ç”¨æ–¹æ³•ï¼š
  1. åœ¨é¡µé¢ front matter ä¸­æ·»åŠ  comments: true å¯ç”¨è¯„è®º
  2. æ·»åŠ  hide_comment: true å¯ä»¥éšè—è¯„è®ºï¼ˆç”¨äºç‰¹æ®Šé¡µé¢ï¼‰
  
  ç¤ºä¾‹ï¼š
  ---
  title: æ–‡ç« æ ‡é¢˜
  comments: true
  ---
#}

{% if page.meta.comments and not page.meta.hide_comment %}
  <!-- Twikoo è¯„è®ºç³»ç»Ÿ -->
  <div class="twikoo-container" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(0,0,0,0.1);">
    <h2 id="__comments" style="margin-bottom: 1rem; font-size: 1.2rem; font-weight: 500;">ğŸ’¬ {{ lang.t("meta.comments") or "è¯„è®º" }}</h2>
    <div id="tcomment" class="loading" style="min-height: 200px;">
      <p style="text-align: center; color: #666; padding: 2rem;">è¯„è®ºç³»ç»ŸåŠ è½½ä¸­...</p>
    </div>
  </div>

  <style>
  .twikoo-container {
    max-width: 100%;
  }

  /* æš—è‰²æ¨¡å¼é€‚é… */
  [data-md-color-scheme="slate"] .twikoo-container {
    border-top-color: rgba(255,255,255,0.1);
  }

  [data-md-color-scheme="slate"] .twikoo-container h2 {
    color: rgba(255,255,255,0.87);
  }

  /* åŠ è½½çŠ¶æ€æ ·å¼ */
  #tcomment.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.02);
    border-radius: 8px;
  }

  [data-md-color-scheme="slate"] #tcomment.loading {
    background: rgba(255,255,255,0.05);
  }

  [data-md-color-scheme="slate"] #tcomment.loading p {
    color: rgba(255,255,255,0.6);
  }
  </style>

  <script>
  (function() {
    // é˜²æ­¢é‡å¤åŠ è½½
    if (window.twikooInitialized) {
      return;
    }

    function loadTwikoo() {
      // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡ Twikoo
      if (window.twikoo) {
        initTwikoo();
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://registry.npmmirror.com/twikoo/1.6.44/files/dist/twikoo.min.js';
      script.onload = function() {
        console.log('Twikoo è„šæœ¬åŠ è½½æˆåŠŸ');
        initTwikoo();
      };
      script.onerror = function() {
        console.error('Twikoo è„šæœ¬åŠ è½½å¤±è´¥');
        const commentEl = document.getElementById('tcomment');
        if (commentEl) {
          commentEl.classList.remove('loading');
          commentEl.innerHTML = '<p style="text-align: center; color: #f56565; padding: 2rem;">è¯„è®ºç³»ç»ŸåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
        }
      };
      document.head.appendChild(script);
    }

    function initTwikoo() {
      const commentEl = document.getElementById('tcomment');
      if (!commentEl) {
        console.warn('è¯„è®ºå®¹å™¨æœªæ‰¾åˆ°');
        return;
      }

      commentEl.classList.remove('loading');

      try {
        twikoo.init({
          envId: 'https://superb-salamander-e730b6.netlify.app/.netlify/functions/twikoo',
          el: '#tcomment',
          lang: 'zh-CN',
          path: location.pathname,
          onCommentLoaded: function () {
            console.log('è¯„è®ºåŠ è½½å®Œæˆ');
          },
          onError: function(err) {
            console.error('Twikoo åˆå§‹åŒ–å¤±è´¥:', err);
            commentEl.innerHTML = '<p style="text-align: center; color: #f56565; padding: 2rem;">è¯„è®ºç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>';
          }
        });
        window.twikooInitialized = true;
      } catch (error) {
        console.error('Twikoo åˆå§‹åŒ–å¼‚å¸¸:', error);
        commentEl.innerHTML = '<p style="text-align: center; color: #f56565; padding: 2rem;">è¯„è®ºç³»ç»Ÿåˆå§‹åŒ–å¼‚å¸¸</p>';
      }
    }

    // æ”¯æŒå³æ—¶å¯¼èˆª
    if (typeof window.document$ !== 'undefined' && !window.document$.isStopped) {
      window.document$.subscribe(function() {
        // é‡ç½®åˆå§‹åŒ–æ ‡å¿—
        window.twikooInitialized = false;
        // å»¶è¿ŸåŠ è½½ä»¥ç¡®ä¿ DOM å·²æ›´æ–°
        setTimeout(loadTwikoo, 100);
      });
    } else {
      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadTwikoo);
      } else {
        loadTwikoo();
      }
    }
  })();
  </script>
{% endif %}
